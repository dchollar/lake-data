<!DOCTYPE html>
<html lang="en-US" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Pipe Lake Data Entry</title>

    <link rel="apple-touch-icon" sizes="180x180" th:href="@{/ico/apple-touch-icon.png}"/>
    <link rel="icon" sizes="32x32" th:href="@{/ico/favicon-32x32.png}" type="image/png"/>
    <link rel="icon" sizes="16x16" th:href="@{/ico/favicon-16x16.png}" type="image/png"/>
    <link rel="manifest" th:href="@{/ico/site.webmanifest}"/>

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"/>
    <link crossorigin="anonymous" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" rel="stylesheet"/>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>
<body>

<script>
    function getLocations() {
        $("#message").text("").hide();
        let siteId = document.getElementById("sitesChoice").value;
        if (siteId) {
            $.ajax(
                {
                    type: "GET",
                    url: "/public/api/sites/" + siteId + "/locations",
                    dataType: "json",
                    success: function (locations) {
                        buildLocationsChoice(locations);
                    },
                    error: function (xhr) {
                        $("#message").text("There was an issue with your request. " + xhr.responseJSON.errorMessage).show();
                    }
                });
        } else {
            $('#locationsChoice').html('<option value=""></option>');
            $("#locationsChoice").trigger('contentChanged');
        }
    }

    function buildLocationsChoice(locations) {
        let html = '<option value=""></option>';
        for (let location of locations) {
            html += '<option value="';
            html += location.id;
            if (location.comment) {
                html += '" title="';
                html += location.comment;
            }
            html += '">';
            html += location.description;
            html += '</option>';
        }
        $('#locationsChoice').html(html);
        $("#locationsChoice").trigger('contentChanged');
    }
</script>

<nav class="navbar navbar-expand-sm bg-dark navbar-dark">
    <a class="navbar-brand" th:href="@{/index}">Pipe Lake Data</a>
    <div class="container-fluid">
        <ul class="navbar-nav">
            <li class="nav-item"><a class="nav-link" th:href="@{/public/page/documents}">Documents</a></li>
            <li class="nav-item"><a class="nav-link" href="https://pipelakes.org/">Pipe Lake District</a></li>
            <li class="nav-item"><a class="nav-link" href="https://dnr.wi.gov/lakes/lakepages/LakeDetail.aspx?wbic=2490500">DNR Pipe Lake</a></li>
            <li class="nav-item" sec:authorize="hasAnyRole('ROLE_REPORTER','ROLE_ADMIN')"><a class="nav-link" th:href="@{/page/dataEntry}">Enter Data</a></li>
            <li class="nav-item dropdown" sec:authorize="hasAnyRole('ROLE_DOCUMENT_ADMIN','ROLE_ADMIN')">
                <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" id="nav-maintenance">Maintenance</a>
                <div class="dropdown-menu bg-dark">
                    <a class="dropdown-item text-light" th:href="@{/page/documentMaintenance}">Documents</a>
                    <div sec:authorize="hasRole('ROLE_ADMIN')">
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item text-light" th:href="@{/page/fundingSourceMaintenance}">Funding Sources</a>
                        <a class="dropdown-item text-light" th:href="@{/page/characteristicMaintenance}">Characteristics</a>
                        <a class="dropdown-item text-light" th:href="@{/page/locationMaintenance}">Locations</a>
                        <a class="dropdown-item text-light" th:href="@{/page/characteristicLocationMaintenance}">Characteristic Locations</a>
                        <a class="dropdown-item text-light" th:href="@{/page/dataMaintenance}">Measurements</a>
                        <a class="dropdown-item text-light active" th:href="@{/page/dataFileUpload}">Data File Upload</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item text-light" th:href="@{/page/userMaintenance}">Users</a>
                        <a class="dropdown-item text-light" th:href="@{/page/audit}">Audit</a>
                        <a class="dropdown-item text-light" th:href="@{/page/jobs}">Job Maintenance</a>
                        <a class="dropdown-item text-light" th:href="@{/swagger-ui.html}">API Documentation</a>
                    </div>
                </div>
            </li>
        </ul>
        <ul class="navbar-nav">
            <li class="nav-item" sec:authorize="isAnonymous()"><a class="nav-link" th:href="@{/login}"><i aria-hidden="true" class="fas fa-sign-in-alt"></i>Login</a></li>
            <li class="nav-item" sec:authorize="isAuthenticated()"><a class="nav-link" th:href="@{/logout}"><i aria-hidden="true" class="fas fa-sign-out-alt"></i>Logout</a></li>
            <li class="nav-item" data-target="#helpModal" data-toggle="modal"><i class="text-secondary far fa-question-circle"></i></li>
        </ul>
    </div>
</nav>

<form method="POST" action="/page/measurementFileUpload" enctype="multipart/form-data">
    <div class="container-fluid text-center">
        <div class="row content">
            <div class="col-sm-1 bg-secondary text-light" id="selectionDiv">
                <div class="container"></div>
            </div>

            <div class="col-sm-11 text-left" id="resultDiv">
                <div class="container-fluid">
                    <span class="bg-danger text-white" th:text="${errorMessage}" id="message"></span><br>

                    <div class="row form-group" id="siteSelectionDiv">
                        <div class="col-sm-2">
                            <label for="sitesChoice">Site:</label>
                        </div>
                        <div class="col-sm-4">
                            <select class="form-control" required="required" id="sitesChoice" name="sitesChoice" onchange="getLocations()">
                                <option value=""></option>
                                <option th:each="site : ${sites}" th:utext="${site.description}" th:value="${site.id}"/>
                            </select>
                        </div>
                    </div>

                    <div class="row form-group" id="locationSelectionDiv">
                        <div class="col-sm-2"><label for="locationsChoice">Location:</label></div>
                        <div class="col-sm-4">
                            <select class="form-control" required="required" id="locationsChoice" name="locationsChoice">
                                <option value=""></option>
                            </select>
                        </div>
                    </div>

                    <div class="row form-group" id="fileUploadDiv">
                        <div class="col-sm-2">
                            <label for="dataFile">Data file from sensor:</label>
                        </div>
                        <div class="col-sm-4">
                            <input type="file" required="required" id="dataFile" name="dataFile">
                        </div>
                    </div>

                    <div class="row form-group pt-3" id="submitSelectionDiv">
                        <input class="btn btn-primary" id='submitButton' name='submitButton' type="submit" value="Submit"/>
                    </div>
                </div>
            </div>

        </div>
    </div>
</form>

<footer class="page-footer bg-dark text-light font-small">
    <div class="container-fluid text-center  font-weight-light">
        <div class="row">
            <div class="col-sm-2 text-left">
                <p><small><a th:href="@{/public/page/privacy}">Privacy Statement</a></small></p>
            </div>
            <div class="col-sm-8"></div>
            <div class="col-sm-2 text-right">
                <p><small>Version: <span th:text="${version}"></span></small></p>
            </div>
        </div>
    </div>
</footer>

<!-- The Help Modal -->
<div class="modal fade" id="helpModal">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
                <h3 class="modal-title">File Upload Help</h3>
            </div>

            <!-- Modal body -->
            <div class="modal-body">
                <h5>Overview</h5>
                <p>
                    The purpose of this page is for the uploading of data files that contain data from automatic monitoring devices. These devices are currently used to monitor
                    stream flow and levels. There are currently two different types of data files. One is collected automatically and transferred directly to this system. If that
                    automatic process were to fail this page provides a means for uploading that missing file. The other type of file is obtained manually from devices not
                    connected directly to the system. This page will be the primary means of uploading that data into this system.
                </p>
                <h5>Site</h5>
                <p>Choose the general site the monitoring device is associated with.</p>
                <h5>Location</h5>
                <p>
                    The list of locations is associated to the site chosen. You will need to select the location associated to the monitoring device the data file is associated
                    with.
                </p>

                <h5>The Data File</h5>
                <p>
                    The data file should either be a single CSV file or a ZIP file containing one or more CSV files. If uploading multiple files in a ZIP file, ALL files need to be
                    from the same sensor.
                </p>
                <h5>Submit</h5>
                <p>
                    When done press the Submit button to save your data entry. If all goes well you will get a message that it is saved and the screen will be reset so you can
                    upload a new data file. If something went wrong the error message will be displayed at the top of the page and you will need to fix your data or contact the
                    administrator.
                </p>
            </div>

            <!-- Modal footer -->
            <div class="modal-footer">
                <button class="btn btn-primary" data-dismiss="modal" type="button">Close</button>
            </div>

        </div>
    </div>
</div>

</body>
</html>
